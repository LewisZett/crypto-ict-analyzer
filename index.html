<script>
    const API_KEY = 'CG-Zm3zjY4tovP4XsqfM2B8chcf';  // Your CoinGecko Pro key

    function getJohannesburgTime() {
        return new Date().toLocaleString('en-US', { timeZone: 'Africa/Johannesburg' });
    }

    function isInKillZone() {
        const now = new Date();
        const johannesburgTime = new Date(now.toLocaleString('en-US', { timeZone: 'Africa/Johannesburg' }));
        const hours = johannesburgTime.getHours();
        const minutes = johannesburgTime.getMinutes();
        const timeInMinutes = hours * 60 + minutes;
        const lkzStart = 9 * 60;    // 09:00 GMT+2
        const lkzEnd = 12 * 60;     // 12:00 GMT+2
        const nykzStart = 15.5 * 60; // 15:30 GMT+2
        const nykzEnd = 18 * 60;    // 18:00 GMT+2
        return (timeInMinutes >= lkzStart && timeInMinutes <= lkzEnd) ||
               (timeInMinutes >= nykzStart && timeInMinutes <= nykzEnd);
    }

    async function fetchWithRetry(url, options, retries = 3) {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url, options);
                if (response.ok) return response;
                if (response.status === 429) {
                    await new Promise(resolve => setTimeout(resolve, 2000 * (i + 1)));
                    continue;
                }
                throw new Error(`HTTP ${response.status}`);
            } catch (error) {
                if (i === retries - 1) throw error;
                await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
            }
        }
    }

    async function loadTrades() {
        const outputDiv = document.getElementById('output');
        const btn = document.getElementById('analyzeBtn');
        btn.disabled = true;
        btn.textContent = 'Analyzing...';
        outputDiv.innerHTML = '<p class="loading">Fetching data from CoinGecko Pro... (Quick, under 5 seconds)</p>';

        try {
            const url = `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=50&page=1&sparkline=false&price_change_percentage=24h`;
            const response = await fetchWithRetry(url, {
                method: 'GET',
                headers: {
                    'x-cg-pro-api-key': API_KEY,
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`API error: ${response.status}`);
            }

            const cryptos = await response.json();

            const positiveMovers = cryptos
                .filter(crypto => crypto.price_change_percentage_24h > 5)  // Very positive: >5% 24h gain (HTF bullish bias)
                .sort((a, b) => (b.total_volume || 0) - (a.total_volume || 0))  // Sort by 24h volume (liquidity pools)
                .slice(0, 10);  // Top 10

            if (positiveMovers.length === 0) {
                outputDiv.innerHTML = '<p>No cryptos with >5% positive moves found. Try again later.</p>';
                return;
            }

            let output = `<h2>ICT Analysis Summary (Multi-Timeframe Emulation)</h2>
            <p><strong>HTF (H1 Bias):</strong> Bullish structure (HH/HL via 24h gains >5%). Liquidity targets above recent highs (BSL sweeps noted in volume).</p>
            <p><strong>MTF (M15 Confirmation):</strong> Confluence with high volume (SMC manipulation avoided; Asian Range bias if pre-09:00). Setups: Liquidity Sweep + OTE retrace.</p>
            <p><strong>LTF (M1 Precision):</strong> Entry at simulated 70% Fib OTE discount. Invalidation beyond OB low.</p>
            <p><strong>Time Cycle:</strong> Current JHB time: ${getJohannesburgTime()}. ${isInKillZone() ? 'In Kill Zone (high prob). Prioritize!' : 'Outside Kill Zone. Wait for LKZ/NYKZ.'}</p>
            <p><strong>Overall:</strong> Valid setups only (R:R >2:1, $1 risk). PO3: Post-accumulation expansion phase.</p>

            <h3>Top 10 Very Positive Sniper Trade Plans</h3>
            <ul>`;

            positiveMovers.forEach(crypto => {
                const name = crypto.name;
                const symbol
